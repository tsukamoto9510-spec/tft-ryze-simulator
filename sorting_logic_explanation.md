# 検索ロジックと並び替えルールの解説

## 現在の挙動の理由

ユーザーが経験した「一貫性のなさ」は、現在のアルゴリズムが **「条件を満たす最小構成を見つける（Minimal Subset Logic）」** ように設計されている一方で、**「候補フィルタリング」** と **「探索順序」** の副作用によって、検索条件が増えると意図せず大きな構成が見つかりやすくなることに起因しています。

### 1. 候補者の絞り込み (Filtering)
`logic.js` の `search` 関数では、計算量を減らすために、検索対象となるチャンピオンを絞り込んでいます。

```javascript
// logic.js 144行目付近
return (c.mask & neededMask) !== 0;
```

- **「アイオニア2」のみ指定:** 「アイオニア」属性を持つユニットしか検索候補に入りません。
- **「アイオニア2・ヨードル2」指定:** 「アイオニア」または「ヨードル」を持つ全ユニットが候補になります。

### 2. 探索の打ち切り (Pruning & Early Return)
探索関数 `solve` は、条件が満たされた（`unsatisfied === 0`）時点で、その構成を結果リストに追加し、**直ちに `return`（終了）** します。

```javascript
// logic.js 173-180行目
if (unsatisfied === 0) {
    results.push({ ... });
    return; // <--- ここで探索を止めている
}
```

- **アイオニア2の場合:**
  - 順当に2体（例: シェン、ジン）を選んだ時点で条件達成となるため、そこで探索が止まります。「あと6枠あるから他のアイオニアユニットも入れてみよう」という処理は行われません。
  - 結果として、2体・低コストの構成が大量に見つかり、それらが表示されます。

- **アイオニア2・ヨードル2の場合:**
  - 2つの条件を満たすのは難易度が高いため、探索が深くなります。
  - プログラムは「ユニットを入れる」か「入れずにスキップする」かを分岐して全通り試します。
  - **「スキップ」のルート** では、序盤のアイオニアユニットをあえて採用せず、後半のユニットまで検索が進みます。その過程で、候補リストに含まれている「ヨードル」ユニットが多数採用される（拾われる）ことがあります。
  - 最終的に条件（アイオニア2・ヨードル2）を満たしたとき、手元には「多数のヨードル + 少数のアイオニア」という8体構成が出来上がっていることがあります。

### 3. スコアリングとソート (Scoring & Sorting)
結果は以下の順序でソートされます。

```javascript
// logic.js 230行目
results.sort((a, b) => b.score - a.score || a.totalCost - b.totalCost);
```

1. **スコア（発動シナジーのレベル合計）が高い順**
2. **合計コストが安い順**

- **アイオニア2の場合:** 2体で止まる構成はどれもスコアが低め（アイオニア2は発動しない場合スコア0、発動しても1）で横並びになります。そのため、2番目の基準である「コスト」により、少人数の構成が上位に来ます。
- **混合の場合:** 偶発的に見つかった「8体構成（ヨードル多数）」は、「ヨードル6」などの高レベルシナジーが発動しているため、スコアが非常に高くなります。その結果、2番目のコスト基準を無視して、リストの一番上に躍り出ます。

## 解決策の提案 (Implementation Plan)

もし「最大ユニット数いっぱいまで使って、最強の構成を提案してほしい」というのがユーザーの意図であれば、以下の修正が有効です。

1. **即時終了の廃止:** 条件を満たしても `return` せず、枠が余っているなら探索を継続するように変更する。
2. **候補の緩和（オプション）:** 現在は指定シナジーに関係ないユニットを完全に除外していますが、「枠埋め要員」として汎用ユニットを許可するか、あるいは「条件を満たした後は同一シナジーの別ユニットを追加することを許可する」ロジックにする。

この変更を行うことで、「アイオニア2」で検索しても、8枠全てを使って「アイオニア7」や「アイオニア5 + 他シナジー」のような高スコア構成が提案されるようになります。
